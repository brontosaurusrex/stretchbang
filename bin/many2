#!/bin/bash

set -e

# global tmp dir http://mywiki.wooledge.org/BashFAQ/062
tmp="/tmp/$RANDOM-$$"
trap '[ -n "$tmp" ] && rm -fr "$tmp"' EXIT
mkdir -m 700 "$tmp" || { echo '!! unable to create a tmpdir' >&2; tmp=; exit 1; }

# global method
# methods to try https://imagemagick.org/script/compose.php
method=( overlay plus darken lighten src-over multiply screen pegtop-light pin-light )

set -x

# reusable composing function
many2 () {
    
    local ltmp="$1" # tmp dir
    local lmethod="${method[@]}"
    local lback="$3"
    local llogo="$4"
    local lsubname="$5"
    local loutdir="$6"
    local loutbase="$7"
    local loutext="$8"
    
    local ltonedown="$9"
    local lgrvt="${10}" # if omitted then center
    
    [[ -z "$lgrvt" ]] && local lgvrt="center"
    [[ -z "$ltonedown" ]] && local ltonedown="90"
    
    # loop
    for var in "${lmethod[@]}"
    do
        echo "${var}"

        touch "${loutdir}/${loutbase}-${var}${lsubname}.${loutext}" 
        
        # action
        convert "$lback" "$llogo" -gravity "${lgvrt}" -compose "${var}" -depth 8 +repage -composite "$ltmp/one.png" 
        
        # tone down
        convert "$lback" "$ltmp/one.png" -define compose:args=$ -compose blend -depth 8 +repage -composite "${loutdir}/${loutbase}-${var}${lsubname}.${loutext}" 
        
        echo "${loutdir}/${loutbase}-${var}${lsubname}.${loutext}"

    done
}

many2 "$tmp" "" "back.png" "logo.png" "Subname" "~/walltest/auto/" "testing" "png"

#
# many2 notes
# many2 "$tmp" "${lmethod[@]}" "$back" "$logo" "$subname" etc ...
#
# ----------------------------------
# tmp - tmp dir
# lmethod (array)
# back
# logo
# subname - refers to action and final naming of files
# outdir - actual output dir
# outbase - basename
# outext - extension 

# tonedown percent # if undefined then 90
# grvt # if undefined then 'center'
