#!/bin/bash

# give me some noise

# checks
command -v convert >/dev/null 2>&1 || { echo "I need imagemagick convert, exiting." >&2; exit 1; }
command -v nitrogen >/dev/null 2>&1 || { echo "I need nitrogen, exiting." >&2; exit 1; }

# store & vars

text="/tmp/text.png"    # tmp text file when needed
file="/tmp/noise.png"   # final wallpaper

mx=1920; my=1200 ; mxsmall=$(( mx / 2 )) ; mysmall=$(( my / 2 ))

# fill colors

tilix="#263945" ; crunch="#222D32" ; deep="#0D314D" ; royal="#2842B3" ; adapta="#222D32" ; deep2="#192F49"

color="$tilix"

# tint

tint="100"

# functions

one () {
head -c "$((3*mx*my))" /dev/urandom | convert -depth 8 -size "${mx}x${my}" RGB:- -colorspace gray -fill "$color" +level 21%,24% -tint 100 -sharpen 0x1 "$file"
}

two () {
convert -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 2 +noise poisson -colorspace gray -fill "$color" +level 18%,24% -tint "$tint" -sharpen 0x1 "$file"
}
# +level 18%,24%
# -sharpen 0x1

disks () {
convert -size "${mx}x${my}" xc:"gray(20%)" -seed "${RANDOM}" -attenuate 4 +noise poisson -colorspace gray -fill "$color" -define morphology:compose=Multiply -morphology Dilate Disk:6 -blur 0x3 +level 17%,45% -tint 100 "$file"
}

dots () {
convert -size "${mxsmall}x${mysmall}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 26 +noise random -colorspace gray -fill "$color" -negate -adaptive-resize "${mx}x${my}" +level 18%,32% -tint 100 "$file"
}

dotsdisks () {
convert -size "${mxsmall}x${mysmall}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 26 +noise random -colorspace gray -fill "$color" -negate -adaptive-resize "${mx}x${my}" -define morphology:compose=Multiply -morphology Dilate Disk:6 -blur 0x3 +level 18%,32% -tint 100 "$file"  
}

multi () {
convert \( -size "${mxsmall}x${mysmall}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 32 +noise random -colorspace gray -fill "$color" -negate -adaptive-resize "${mx}x${my}" -define morphology:compose=Multiply -morphology Dilate Disk:6 -blur 0x1 -adaptive-resize "${mxsmall}x${mysmall}" -adaptive-resize "${mx}x${my}" \) \
-compose lineardodge \
\( -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 2 +noise poisson -colorspace gray \) \
-composite +level 18%,22% -tint 100 "$file"
}

multi2 () {
convert \( -size "${mxsmall}x${mysmall}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 32 +noise random -colorspace gray -fill "$color" -negate -adaptive-resize "${mx}x${my}" -define morphology:compose=Multiply -morphology Dilate Disk:2 -blur 0x1 -adaptive-resize "${mxsmall}x${mysmall}" -adaptive-resize "${mx}x${my}" \) \
-compose Plus \
\( -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 2 +noise poisson -colorspace gray \) \
-composite +level 18%,28% -tint 100 "$file"
}

# https://www.imagemagick.org/Usage/compose/#math

dual () {
convert \( -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 2 +noise gaussian  \) \
-compose Pegtop_Light \
\( -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" -attenuate 3 +noise poisson \) \
-composite -negate -fill "$color" +level 18%,24% -tint 100 "$file"
}

three () {
convert -size "${mx}x${my}" xc:"gray(50%)" -seed "${RANDOM}" +noise random -modulate 50,0 -colorspace gray -fill "$color" +level 18%,24% -tint 100 "$file"   
# +level 18%,24% 
}

# https://www.imagemagick.org/Usage/text/
annotate () {
convert \( -size "${mx}x${my}" xc:"black" -pointsize 40 -interline-spacing 0 -kerning 18 -gravity center -font Antonio-Light -fill "#232323" -annotate +0-35 "$1" -blur 0x.1 -seed "${RANDOM}" -attenuate 8 +noise poisson -colorspace gray  \) "$file" \
-compose add \
-composite "$file"
}
# add
# -attenuate 2
# -pointsize 40
# -fill "#202020"

annotateBox () {
convert -size "500x500" -background none xc:"black" -interline-spacing 0 -kerning 0 -font Antonio-Light -fill "#232323" caption:"$1" -blur 0x.1 -seed "${RANDOM}" -attenuate 8 +noise poisson -colorspace gray -gravity center -trim -extent "${mx}x${my}"+0+10 -composite "$text"
# -gravity center
# -pointsize 40
# -kerning 8
# -interline-spacing 0
convert "$text" "$file" -compose add -composite "$file"
}

# Fixed width, sliver kind of fx
annotateBoxFixed () {
mxthird=$(( mx / 6 )) 
convert -size "${mx}x${mx}" -background none xc:"black" -interline-spacing 10 -kerning 5 -font Antonio-Light -fill "#373737" caption:"$1" -blur 0x.1 -resize "${mxthird}x" -seed "${RANDOM}" -attenuate 8 +noise poisson -colorspace gray -gravity center -trim -extent "${mx}x${my}"+0+10 -composite "$text"
# -fill "#232323"

convert "$text" "$file" -compose add -composite "$file"
convert "$text" -blur 0x1 -extent "${mx}x${my}"-0-1 "$file" -compose minus -composite "$file"
convert "$text" "$file" -compose add -composite "$file"
convert "$text" -blur 0x1 -extent "${mx}x${my}"-0+1 "$file" -compose minus -composite "$file"
convert "$text" -blur 0x2 "$file" -compose add -composite "$file"
}

# Fixed width, plastic kind of fx
annotateBoxFixed2 () {
mxthird=$(( mx / 7 )) 
 
convert -size "${mx}x${mx}" -background none xc:"black" -interline-spacing 10 -kerning 5 -font Antonio-Light -fill "#474747" caption:"$1" -blur 0x.1 -resize "${mxthird}x" -seed "${RANDOM}" -attenuate 12 +noise poisson -colorspace gray -gravity center -trim -extent "${mx}x${my}"+0+10 -composite "$text"
# -fill "#232323"

convert "$text" -blur 0x1 -extent "${mx}x${my}"-0-1 "$file" -compose minus -composite "$file"
convert "$text" -blur 0x2 -extent "${mx}x${my}"-0+2 "$file" -compose add -composite "$file"
convert "$text" "$file" -compose add -composite "$file"
}

setwall () {
    nitrogen --set-tiled "$file"
}

setwall1 () {
    nitrogen --head=0 --set-tiled "$file"
}

setwall2 () {
    nitrogen --head=1 --set-tiled "$file"
}

restart() {
if pgrep -x "$1" > /dev/null
then
    (echo "$1 running, restarting"
    killall -w "$1"
    "${1}" &) &
else
    echo "$1 wasn't running"
fi
}

clean() {
    rm "/tmp/text.png"
    rm "/tmp/noise.png"
}

fortunefunc () {
# limit string lenght
string="$(fortune | tr -d '\t')"
until ! [ ${#string} -ge 100 ]; do
    string="$(fortune | tr -d '\t')"
done
    
echo "$string"    
}
# -s is for short ones

# do it

color="$deep"

set -x

#setwall1

# You will need a defined font installed for this to work
#annotate "$(lsb_release -cs | tr '[:lower:]' '[:upper:]' )" 
#annotate "bulk"
#annotate "So it it looks a lil green."

#annotateBox "$(fortune -s cbbl | tr -d '\t' | tr -d '\n' | tr -s " ")"

two
setwall
exit 

# -------------------------------


two

# https://brontosaurusrex.github.io/2018/08/07/seen/
until var="$(seen "$(fortune -s)" 2>/dev/null)"; do : ; done 
annotateBoxFixed2 "$(echo "$var" | tr -d '\t' | tr -s " " | grep -ve '--')"

setwall1

#annotateBox "$(fortune fortunes | tr -d '\t' | tr -d '\n' | tr -s " ")"

# annotate "The time is right\nto make new friends"
# fold -w 20 -s <(echo "The time is right to make new friends")

two

# https://brontosaurusrex.github.io/2018/08/07/seen/
until var="$(seen "$(fortune -s)" 2>/dev/null)"; do : ; done 
annotateBoxFixed2 "$(echo "$var" | tr -d '\t' | tr -s " " | grep -ve '--')"

setwall2

set +x


#restart wbar

# notes
# https://www.imagemagick.org/script/command-line-options.php?ImageMagick=ogkomddlqbb40ivi7b0ocrddr4#noise

# add some text
 #mogrify -pointsize 20 -gravity center -font cuprum -annotate 0 "$(uname -a)" /tmp/noise.png
