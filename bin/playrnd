#!/bin/bash

# playrnd

# required: seen (script), printWaveform (script) (or change it to mpv)

# usage: 
# playrnd .            
# playrnd "album1/" "album2/"

# test how much musik is there:
# cd /your/music/root
# find . -type f | grep -E '.mp3$|.mp4$|.m4a$|.flac$|.ogg$|.mpc$|.wav$|.aif$|.opus$' | wc -
# and set "$lm accordingly", or don't and things will play until there is nothing left and stop with 'lock prevented' message.

# checks
command -v mpv >/dev/null 2>&1 || { echo >&2 "I require mpv but it's not installed, exiting."; exit 1; }
command -v seen >/dev/null 2>&1 || { echo >&2 "I require 'seen' script but it's not on path, exiting."; exit 1; }
command -v printWaveform >/dev/null 2>&1 || { echo >&2 "I require 'printWaveform' script but it's not on path, exiting."; exit 1; }

# seen limit and database
lm="200"
db="muzak"
    
# main
while true; do # forever
    # action
    c="0"
    unlock="60" # This could depend on limit/members ratio
    until
        # Note: find|grep|shuf for every song is kinda not optimal,
        # but will cover the case when one adds music while script is in action.
        muzak="$(seen $lm $db "$( find "$@" -type f | grep -E '.mp3$|.mp4$|.m4a$|.flac$|.ogg$|.mpc$|.wav$|.aif$|.opus$' | shuf -n 1 )"  2>/dev/null)"
    do 
        # lock prevention
        (( c++ ))
        if (( c == unlock )); then 
             >&2 echo "lock prevented"
            exit
        fi
    done 

    # play or don't
    if ! [[ -z "$muzak" ]]; then
        #echo "$muzak"
        printWaveform "$muzak"
    else
        echo " ##### no muzak for you ##### "
    fi
done
