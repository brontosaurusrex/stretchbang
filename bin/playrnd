#!/bin/bash

# playrnd

# required: seen (script), printWaveform (script) (or change it to mpv)

# usage: 
#           playrnd .            
#           playrnd "album1" "album2"

# checks
command -v mpv >/dev/null 2>&1 || { echo >&2 "I require mpv but it's not installed, exiting."; exit 1; }
command -v seen >/dev/null 2>&1 || { echo >&2 "I require 'seen' script but it's not installed, exiting."; exit 1; }
command -v printWaveform >/dev/null 2>&1 || { echo >&2 "I require 'printWaveform' script but it's not installed, exiting."; exit 1; }

# var
lm="16"
db="muzak"

while true; do
    # action
    c="0"
    unlock="60" # This could depend on limit/members ratio
    until 
        muzak="$(seen $lm $db "$( find "$@" -type f | grep -E '.mp3$|.mp4$|.m4a$|.flac$|.ogg$|.mpc$|.wav$|.aif$|.opus$' | shuf -n 1 )"  2>/dev/null)"
    do 
        # lock prevention
        (( c++ ))
        if (( c == unlock )); then 
             >&2 echo "lock prevented"
            exit
        fi
    done 

    # play or don't
    if ! [[ -z "$muzak" ]]; then
        printWaveform "$muzak"
    else
        echo " ##### no muzak for you ##### "
    fi
done
