#!/bin/bash

# playrnd

# required: seen (script), printWaveform (script) (or change it to mpv)

# usage: playrnd --help

# checks
command -v mpv >/dev/null 2>&1 || { echo >&2 "I require mpv but it's not installed, exiting."; exit 1; }
command -v seen >/dev/null 2>&1 || { echo >&2 "I require 'seen' script but it's not on path, exiting."; exit 1; }
command -v printWaveform >/dev/null 2>&1 || { echo >&2 "I require 'printWaveform' script but it's not on path, exiting."; exit 1; }

# seen limit and database
lm="200"
db="muzak"

# nuke the seen database
if [ "$1" == "--nuke" ] ; then
    seen "0" "$db" "" >/dev/null 2>&1
    echo "seen db forgot"
    exit
elif [ "$1" == "-h" ] || [ "$1" == "--help" ]; then # help

cat <<EOF

    cd /your/music/root && playrnd .     
           
    playrnd "/path/to/album1" "/path/to/album2"
    
    playrnd --nuke # nuke the seen database, this should be useful when 'limit > number of songs'.

EOF

exit

fi

# stats
all="$(find "$@" -type f | grep -E '.mp3$|.mp4$|.m4a$|.flac$|.ogg$|.mpc$|.wav$|.aif$|.opus$' -c)"
echo "Found $all songs, 'seen' limit set to $lm."
    
# main
while true; do # forever
    # action
    c="0"
    unlock="60" # This could depend on limit/members ratio
    until
        # Note: find|grep|shuf everything for every song is kinda not optimal,
        # but will cover the case when one adds music while script is in action.
        muzak="$(seen $lm $db "$( find "$@" -type f | grep -E '.mp3$|.mp4$|.m4a$|.flac$|.ogg$|.mpc$|.wav$|.aif$|.opus$' | shuf -n 1 )"  2>/dev/null)"
    do 
        # lock prevention
        (( c++ ))
        if (( c == unlock )); then 
             >&2 echo "lock prevented"
            exit
        fi
    done 

    # play or don't
    if ! [[ -z "$muzak" ]]; then
        #echo "$muzak"
        printWaveform "$muzak"
    else
        echo " ##### no muzak for you ##### "
    fi
done
