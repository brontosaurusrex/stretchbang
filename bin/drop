#!/bin/bash

# drop

# Drop stuff to be played in mpv to playlist
# This is workaround for chrome not supporting shift+drag behavior

# needs: yad, mpv, youtube-dl, socat

#set -x

pipe="/tmp/pipe" && touch "$pipe"

isRunning () {

    # lets query whatever to see if the thing is already running
    if [ ! -f "$pipe" ] && (echo '{ "command": ["get_property", "mpv-version"] }' | socat - "$pipe") &> /dev/null ; then 
        echo "Mpv instance already running"

    else
        echo "Mpv not running, starting now"
        
        mpv --idle --force-window --autofit-larger=50% --geometry 49% --input-ipc-server="$pipe" &
    fi
}

#isRunning

yad --on-top --undecorated --no-buttons --title="drop urls here" --text="\n\n\nDROP" --geometry=200x200+50-50 --text-align=center --dnd | while read url
# --width=200 --height=200

do

    isRunning
    sleep 1 # naive approach to wait until pipe is ready
    echo "$url just droped"
    echo "loadfile $url append-play" | socat - "$pipe"
    youtube-dl -e "$url" # get url title

done



