#!/bin/bash

# drop

# Drop stuff to be played in mpv to playlist
# This is workaround for chrome not supporting shift+drag behavior

# needs: yad, mpv, youtube-dl, socat

pipe="/tmp/pipe" && touch "$pipe"

isRunning () {

    # lets query whatever to see if the thing is already running
    if [ ! -f "$pipe" ] && (echo '{ "command": ["get_property", "mpv-version"] }' | socat - "$pipe") &> /dev/null ; then 
        #echo "Mpv instance already running"
        true
    else
        echo "Mpv not running, starting now"
        
        mpv --idle --force-window --autofit-larger=50% --geometry 49% --input-ipc-server="$pipe" --ytdl-format='bestvideo[ext=mp4][width<=1920][height<=1200]+bestaudio[ext=m4a]' &
        sleep 1 # naive approach to wait until pipe is ready
    fi
}

#isRunning

yad --on-top --no-buttons --title="drop urls here" --text="\n\n\nDROP" --geometry=200x200+50-50 --text-align=center --dnd | while read -r url
# --width=200 --height=200 --undecorated 

do

    isRunning
    echo "$url just droped"
    echo "loadfile \"$url\" append-play" | socat - "$pipe"
    [[ $url == http* ]] && youtube-dl -e "$url" && echo # if url, try to get url title

done
