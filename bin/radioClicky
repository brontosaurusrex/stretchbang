#!/bin/bash

radio="http://wfmu.org/wfmu.pls"
#radio="http://wruv.org/wruv256.m3u"

on=" / "
off=" \\ "

store="$HOME/tmp"
pidPath="$store/radiopid"
mpvtxt="$store/mpv.txt"

mkdir -p "$store"

# crop/clean log
file="$mpvtxt"
if [ -f "$file" ]; then
    tail -n 500 "$file" > "$file.tmp" && cp "$file.tmp" "$file" && rm "$file.tmp"
    touch "$file"
fi

# main
if [ "$1" == "toggle" ]; then

    if [ -f "$pidPath" ]; then
        Rpid=$(cat "$pidPath")
        kill "$Rpid" && rm "$pidPath"
        echo "$off" # off
    else
        mpv --no-video --no-resume-playback --no-ytdl --no-config  "$radio" >> "$mpvtxt" 2>/dev/null &
        Rpid="$!"
        echo "$Rpid" > "$pidPath"
        echo "$on" # on
    fi
    
elif [ "$1" == "notify" ]; then

    icytitle="$(sed -n 's/^ icy-title: //p' "$mpvtxt" | tail -1)" 
    playing="$(sed -n 's/^Playing: //p' "$mpvtxt" | tail -1)"

    >&2 echo "$icytitle"; >&2 echo "$playing"
    
    notify-send -u normal "$icytitle" 2>/dev/null || notify-send -u normal "$playing" 2>/dev/null
    
elif [ "$1" == "last" ]; then
    
    sed -n 's/^ icy-title: //p' "$mpvtxt" | uniq | tail -n 12

else # status

    if [ -f "$pidPath" ]; then
        echo "$on" # on
    else
        echo "$off" # off
    fi

fi


## tint2rc executor
#execp = new
#execp_centered = 1
#execp_has_icon = 0
#execp_command = radioClicky
#execp_continuous = 0
#execp_font = cuprum 12
#execp_font_color = #111111 70
#execp_padding = 0 0 0
#execp_tooltip = radio
#execp_lclick_command = radioClicky toggle
#execp_rclick_command = radioClicky notify
#execp_interval = 12
